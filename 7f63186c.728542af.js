(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{66:function(e,n,t){"use strict";t.r(n),t.d(n,"frontMatter",(function(){return r})),t.d(n,"metadata",(function(){return o})),t.d(n,"rightToc",(function(){return b})),t.d(n,"default",(function(){return s}));var a=t(2),i=t(6),l=(t(0),t(76)),r={title:"Building packages"},o={unversionedId:"build",id:"build",isDocsHomePage:!1,title:"Building packages",description:"Packemon was primarily designed and engineered for building packages. But what is building you ask?",source:"@site/docs/build.md",slug:"/build",permalink:"/docs/build",editUrl:"https://github.com/milesj/packemon/edit/master/website/docs/build.md",version:"current",sidebar:"docs",previous:{title:"Package configuration",permalink:"/docs/config"},next:{title:"Advanced",permalink:"/docs/advanced"}},b=[{value:"Options",id:"options",children:[]},{value:"How it works",id:"how-it-works",children:[]},{value:"Babel configuration",id:"babel-configuration",children:[{value:"Presets",id:"presets",children:[]},{value:"Plugins",id:"plugins",children:[]}]},{value:"Rollup configuration",id:"rollup-configuration",children:[{value:"Plugins",id:"plugins-1",children:[]}]}],c={rightToc:b};function s(e){var n=e.components,t=Object(i.a)(e,["components"]);return Object(l.b)("wrapper",Object(a.a)({},c,t,{components:n,mdxType:"MDXLayout"}),Object(l.b)("p",null,"Packemon was primarily designed and engineered for building packages. But what is building you ask?\nBuilding is the process of parsing, transforming, and bundling a package's source code into\ndistributable and consumable files for NPM, using community favorite tools like ",Object(l.b)("a",Object(a.a)({parentName:"p"},{href:"https://babeljs.io/"}),"Babel")," and\n",Object(l.b)("a",Object(a.a)({parentName:"p"},{href:"https://rollupjs.org"}),"Rollup"),"."),Object(l.b)("p",null,"With that being said, the ",Object(l.b)("inlineCode",{parentName:"p"},"packemon build")," command can be used to build all packages in a project\naccording to their configured build targets (platform, formats, etc)."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"packemon build --checkLicenses --generateDeclaration\n")),Object(l.b)("h2",{id:"options"},"Options"),Object(l.b)("p",null,"Build supports the following command line options."),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"--addEngines")," - Add Node.js and NPM ",Object(l.b)("inlineCode",{parentName:"li"},"engine")," versions to each ",Object(l.b)("inlineCode",{parentName:"li"},"package.json")," when ",Object(l.b)("inlineCode",{parentName:"li"},"platform")," is\n",Object(l.b)("inlineCode",{parentName:"li"},"node"),". Uses the ",Object(l.b)("inlineCode",{parentName:"li"},"support")," setting to determine the version range."),Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"--addExports")," - Add ",Object(l.b)("inlineCode",{parentName:"li"},"exports")," fields to each ",Object(l.b)("inlineCode",{parentName:"li"},"package.json")," according to the respective ",Object(l.b)("inlineCode",{parentName:"li"},"inputs"),"\nsetting. This is an experimental Node.js feature and may not work correctly\n(",Object(l.b)("a",Object(a.a)({parentName:"li"},{href:"https://nodejs.org/api/packages.html#packages_package_entry_points"}),"more information"),")."),Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"--checkLicenses")," - Check that packages have a valid ",Object(l.b)("inlineCode",{parentName:"li"},"license")," field. Will log a warning if\ninvalid."),Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"--concurrency")," - Number of builds to run in parallel. Defaults to operating system CPU count."),Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"--generateDeclaration")," - Generate a single TypeScript declaration for each package according to\nthe ",Object(l.b)("inlineCode",{parentName:"li"},"inputs")," setting. Uses\n",Object(l.b)("a",Object(a.a)({parentName:"li"},{href:"https://www.npmjs.com/package/@microsoft/api-extractor"}),"@microsoft/api-extractor")," to ",Object(l.b)("em",{parentName:"li"},"only"),"\ngenerate the public API."),Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"--skipPrivate")," - Skip ",Object(l.b)("inlineCode",{parentName:"li"},"private")," packages from being built."),Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"--timeout")," - Timeout in milliseconds before a build is cancelled. Defaults to no timeout.")),Object(l.b)("p",null,"By default, ",Object(l.b)("inlineCode",{parentName:"p"},"build")," will find a ",Object(l.b)("inlineCode",{parentName:"p"},"package.json")," in the current working directory. To build a\ndifferent directory, pass a relative path as an argument."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"packemon build ./some/other/path\n")),Object(l.b)("h2",{id:"how-it-works"},"How it works"),Object(l.b)("p",null,"When the build process is ran, Packemon will find all viable packages within the current project and\ngenerate build artifacts. A build artifact is an output file that ",Object(l.b)("em",{parentName:"p"},"will be")," distributed with the NPM\npackage, but ",Object(l.b)("em",{parentName:"p"},"will ",Object(l.b)("strong",{parentName:"em"},"not")," be")," committed to the project (ideally git ignored)."),Object(l.b)("p",null,"To demonstrate this, let's assume we have a package with the following folder structure and file\ncontents (not exhaustive)."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"/\n\u251c\u2500\u2500 src/\n|   \u251c\u2500\u2500 index.ts\n|   \u2514\u2500\u2500 *.ts\n\u251c\u2500\u2500 tests/\n\u251c\u2500\u2500 .npmignore\n\u251c\u2500\u2500 package.json\n\u251c\u2500\u2500 LICENSE\n\u2514\u2500\u2500 README.md\n")),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json",metastring:'title="package.json"',title:'"package.json"'}),'{\n  "name": "package",\n  "packemon": {\n    "inputs": { "index": "src/index.ts" },\n    "platform": ["node", "browser"],\n    "formats": ["lib", "esm", "umd"],\n    "namespace": "Example"\n  }\n}\n')),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{className:"language-ini",metastring:'title=".npmignore"',title:'".npmignore"'}),"src/\ntests/\n*.log\n")),Object(l.b)("p",null,"Based on the package configuration above, our build will target both Node.js and web browsers, while\ngenerating multiple ",Object(l.b)("inlineCode",{parentName:"p"},"index")," outputs across both platforms. The resulting folder structure will look\nlike the following (when also using ",Object(l.b)("inlineCode",{parentName:"p"},"--generateDeclaration"),")."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"/\n\u251c\u2500\u2500 dts/\n|   \u2514\u2500\u2500 index.d.ts\n\u251c\u2500\u2500 esm/\n|   \u2514\u2500\u2500 index.js\n\u251c\u2500\u2500 lib/\n|   \u2514\u2500\u2500 index.js\n\u251c\u2500\u2500 src/\n|   \u251c\u2500\u2500 index.ts\n|   \u2514\u2500\u2500 *.ts\n\u251c\u2500\u2500 tests/\n\u251c\u2500\u2500 umd/\n|   \u2514\u2500\u2500 index.js\n\u251c\u2500\u2500 .npmignore\n\u251c\u2500\u2500 package.json\n\u251c\u2500\u2500 LICENSE\n\u2514\u2500\u2500 README.md\n")),Object(l.b)("p",null,"Furthermore, the ",Object(l.b)("inlineCode",{parentName:"p"},"package.json")," will automatically be updated with our build artifact entry points,\nas demonstrated below. This can further be expanded upon using the ",Object(l.b)("inlineCode",{parentName:"p"},"--addEngines")," and ",Object(l.b)("inlineCode",{parentName:"p"},"--addExports"),"\noptions."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{className:"language-json",metastring:'title="package.json"',title:'"package.json"'}),'{\n  "name": "package",\n  "main": "./lib/index.js",\n  "module": "./esm/index.js",\n  "browser": "./umd/index.js",\n  "types": "./dts/index.d.ts",\n  "packemon": {\n    "inputs": { "index": "src/index.ts" },\n    "platform": ["node", "browser"],\n    "formats": ["lib", "esm", "umd"],\n    "namespace": "Example"\n  }\n}\n')),Object(l.b)("p",null,"Amazing, we now have self-contained and tree-shaken build artifacts for consumption. However, to\nensure ",Object(l.b)("em",{parentName:"p"},"only")," build artifacts are packaged and distributed to NPM, we rely on ",Object(l.b)("inlineCode",{parentName:"p"},".npmignore"),". Based on\nthe ignore contents above, the files published to NPM would be the following."),Object(l.b)("pre",null,Object(l.b)("code",Object(a.a)({parentName:"pre"},{}),"/\n\u251c\u2500\u2500 dts/\n\u251c\u2500\u2500 esm/\n\u251c\u2500\u2500 lib/\n\u251c\u2500\u2500 umd/\n\u251c\u2500\u2500 package.json\n\u251c\u2500\u2500 LICENSE\n\u2514\u2500\u2500 README.md\n")),Object(l.b)("h2",{id:"babel-configuration"},"Babel configuration"),Object(l.b)("p",null,"All packages are parsed and transpiled with ",Object(l.b)("a",Object(a.a)({parentName:"p"},{href:"https://babeljs.io/"}),"Babel")," (through Rollup). The presets and plugins\nused are automatically determined on a package-by-package basis, by inspecting the package's root\nfiles and respective ",Object(l.b)("inlineCode",{parentName:"p"},"package.json")," (and root ",Object(l.b)("inlineCode",{parentName:"p"},"package.json")," if using workspaces)."),Object(l.b)("h3",{id:"presets"},"Presets"),Object(l.b)("p",null,"The environment preset is always enabled and configures the following."),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"@babel/preset-env"),Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"Defines ",Object(l.b)("inlineCode",{parentName:"li"},"modules")," and ",Object(l.b)("inlineCode",{parentName:"li"},"targets")," based on the chosen ",Object(l.b)("a",Object(a.a)({parentName:"li"},{href:"/docs/config#platforms"}),"platform")," and\n",Object(l.b)("a",Object(a.a)({parentName:"li"},{href:"/docs/config#formats"}),"format"),"."),Object(l.b)("li",{parentName:"ul"},"Enables ",Object(l.b)("inlineCode",{parentName:"li"},"spec")," and disables ",Object(l.b)("inlineCode",{parentName:"li"},"loose")," for spec compliance."),Object(l.b)("li",{parentName:"ul"},"Enables ",Object(l.b)("inlineCode",{parentName:"li"},"bugfixes")," and ",Object(l.b)("inlineCode",{parentName:"li"},"shippedProposals")," for smaller file sizes."),Object(l.b)("li",{parentName:"ul"},"Disables ",Object(l.b)("inlineCode",{parentName:"li"},"useBuiltIns")," as consumers of the package should polyfill accordingly.")))),Object(l.b)("p",null,"The following presets are enabled when one of their conditions are met."),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"@babel/preset-flow"),Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"Package or root contains a ",Object(l.b)("inlineCode",{parentName:"li"},"flow-bin")," dependency."),Object(l.b)("li",{parentName:"ul"},"Project contains a ",Object(l.b)("inlineCode",{parentName:"li"},".flowconfig"),"."))),Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"@babel/preset-typescript"),Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"Package or root contains a ",Object(l.b)("inlineCode",{parentName:"li"},"typescript")," dependency."),Object(l.b)("li",{parentName:"ul"},"Package contains a ",Object(l.b)("inlineCode",{parentName:"li"},"tsconfig.json"),"."))),Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"@babel/preset-react"),Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"Package contains a ",Object(l.b)("inlineCode",{parentName:"li"},"react")," dependency.")))),Object(l.b)("h3",{id:"plugins"},"Plugins"),Object(l.b)("p",null,"The following plugins are enabled when one of their conditions are met."),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"@babel/plugin-proposal-decorators"),Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"Enabled when package is TypeScript aware and defines ",Object(l.b)("inlineCode",{parentName:"li"},"experimentalDecorators")," in\n",Object(l.b)("inlineCode",{parentName:"li"},"tsconfig.json"),"."))),Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"babel-plugin-transform-async-to-promises"),Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"Enabled when package ",Object(l.b)("a",Object(a.a)({parentName:"li"},{href:"/docs/config#platforms"}),"platform")," is configured to ",Object(l.b)("inlineCode",{parentName:"li"},"browser"),". This attempts\nto ",Object(l.b)("em",{parentName:"li"},"avoid")," ",Object(l.b)("inlineCode",{parentName:"li"},"regenerator-runtime")," by transforming async/await to promises."))),Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"babel-plugin-transform-dev"),Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"Always enabled. Will transform ",Object(l.b)("inlineCode",{parentName:"li"},"__DEV__")," to ",Object(l.b)("inlineCode",{parentName:"li"},"process.env.NODE_ENV")," conditionals.")))),Object(l.b)("h2",{id:"rollup-configuration"},"Rollup configuration"),Object(l.b)("p",null,"While Babel handles the parsing and transformation of source files, ",Object(l.b)("a",Object(a.a)({parentName:"p"},{href:"https://rollupjs.org"}),"Rollup")," bundles all\nentry point dependent source files into a single tree-shaken distributable file. This vastly reduces\nthe file size, require/import times, evaluation speed, and more."),Object(l.b)("p",null,'However, configuring Rollup can be quite daunting. Because of this, the entire layer is abstracted\naway behind Packemon, and should just "work" when packages are configured correctly. Our abstraction\nabides the following:'),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},"For every input in a package's ",Object(l.b)("a",Object(a.a)({parentName:"li"},{href:"/docs/config#inputs"}),"inputs")," setting, an output file will be\ncreated."),Object(l.b)("li",{parentName:"ul"},"For every ",Object(l.b)("a",Object(a.a)({parentName:"li"},{href:"/docs/config#platforms"}),"platform")," and ",Object(l.b)("a",Object(a.a)({parentName:"li"},{href:"/docs/config#formats"}),"format")," in a package, a\nunique output file will be created."),Object(l.b)("li",{parentName:"ul"},"Every Node.js built-in module is configured as external."),Object(l.b)("li",{parentName:"ul"},"Every package dependency is configured as external."),Object(l.b)("li",{parentName:"ul"},"Always reduces file size as much as possible by utilizing tree-shaking."),Object(l.b)("li",{parentName:"ul"},'Allows input files to reference other input files to mitigate "instance of" and "reference"\nissues.')),Object(l.b)("h3",{id:"plugins-1"},"Plugins"),Object(l.b)("p",null,"The following plugins are enabled per package."),Object(l.b)("ul",null,Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"@rollup/plugin-node-resolve"),Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"Resolves imports using Node.js module resolution."))),Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"@rollup/plugin-commonjs"),Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"Converts CommonJS externals to ECMAScript for bundling capabilities."))),Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"@rollup/plugin-babel"),Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"Parses and transforms source code using Babel."),Object(l.b)("li",{parentName:"ul"},"Excludes test related files from transformation."),Object(l.b)("li",{parentName:"ul"},"Inlines runtime helpers in the output file."),Object(l.b)("li",{parentName:"ul"},"Generates source maps (browser only)."))),Object(l.b)("li",{parentName:"ul"},Object(l.b)("inlineCode",{parentName:"li"},"rollup-plugin-node-externals"),Object(l.b)("ul",{parentName:"li"},Object(l.b)("li",{parentName:"ul"},"Defines ",Object(l.b)("inlineCode",{parentName:"li"},"externals")," based on ",Object(l.b)("inlineCode",{parentName:"li"},"package.json")," dependencies."),Object(l.b)("li",{parentName:"ul"},"Includes ",Object(l.b)("inlineCode",{parentName:"li"},"dependencies"),", ",Object(l.b)("inlineCode",{parentName:"li"},"devDependencies"),", ",Object(l.b)("inlineCode",{parentName:"li"},"peerDependencies"),", and ",Object(l.b)("inlineCode",{parentName:"li"},"optionalDependencies"),".")))))}s.isMDXComponent=!0}}]);